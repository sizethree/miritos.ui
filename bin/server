#!/usr/bin/env node

"use strict";

const path    = require("path");
const dotenv  = require("dotenv");
const express = require("express");
const program = require("commander");
const session = require("express-session");
const connect = require("connect-redis");
const redis   = require("redis");
const fs      = require("fs");
const json5   = require("json5");
const proxy   = require("express-http-proxy");
const btoa    = require("btoa");

function sessionMiddleware(secret, options) {
  let {prefix} = options || {prefix: "miritos"};
  let client   = redis.createClient();
  let Store    = connect(session);
  let store    = new Store({client, prefix});
  return session({secret, store});
}

(function() {

  dotenv.config();

  program
    .option("-p, --port <port>", "the port for express to listen on, defaults to 8080")
    .parse(process.argv);

  let port         = program.port || 8888;
  let app          = express();
  let assets       = path.join(__dirname, "../dist");
  let index        = path.join(__dirname, "../dist/index.html");

  let client_id     = process.env["API_CLIENT_ID"];
  let client_secret = process.env["API_CLIENT_SECRET"];
  let api_url       = process.env["API_REAL_HOME"];

  app.use(sessionMiddleware(process.env["SESSION_SECRET"], {}));

  // serve the js, css from the assets dir
  app.use(express.static(assets));

  function decorateRequest(request, original) {
    let auth_header = btoa([client_id, client_secret].join(":"));
    let query       = original.query;
    let {session}   = original;

    if(query && query.token)
      session.bearer_token = query.token;

    if(session.bearer_token)
      request.headers["X-CLIENT-BEARER-TOKEN"] = session.bearer_token;

    request.headers["X-CLIENT-AUTH"] = auth_header;

    return request;
  }

  app.get("/api/login/google", function(req, res) {
    let url = `${api_url}/oauth/google/prompt?client_id=${client_id}`;
    return res.redirect(url);
  });

  app.get("/api/logout", function(req, res) {
    let {session} = req;
    session.bearer_token = null;
    return res.redirect("/");
  });

  app.use("/api", proxy(api_url, {decorateRequest}));

  // send the same index html for every request - this is a single
  // page application
  app.get("*", function(req, res, next) {
    if(/png|gif|css|js|ttf/i.test(req.path)) return next();
    res.sendFile(index);
  });

  app.listen(port);
  process.stdout.write(`listening on port ${port}\n`);

})();
